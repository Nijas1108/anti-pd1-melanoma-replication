---
title: "aish_analysis"
output: html_document
date: "2026-01-16"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## LOADING LIBRARIES: 
```{r}
library(maftools)
library(dplyr)
library(ggplot2)
library(ggpubr)
library(tidyr)
library(survival)
```

## LOAD IN MMC1 PATIENT METADATA:
```{r, eval=FALSE}
# Read clinical metadata into a dataframe
clinical_df_og <- read.csv("mmc1.csv", stringsAsFactors = FALSE)

# Rename the sample ID column to match the MAF sample ID column (Sample_Barcode) - required when merging data with MAF
# Check CSV and use the name of the column here:
colnames(clinical_df_og)[colnames(clinical_df_og) == "SRA.Run.ID..tumor.WES"] <- "Tumor_Sample_Barcode"
colnames(clinical_df_og)[colnames(clinical_df_og) == "SRA.Run.ID..normal.WES"] <- "Matched_Norm_Sample_Barcode"
```

## LOADING IN MAF FILES: 
```{r, eval=FALSE}
# 1. Define the two directories
ucla_dir <- "/rds/projects/e/elhamsak-group5/main_project/processed_data/wes/annotation/ucla_processed_bed"
vandy_dir <- "/rds/projects/e/elhamsak-group5/main_project/processed_data/wes/annotation/vanderbilt_processed_bed" 

# Collect all MAF files
maf_files <- c(
  list.files(ucla_dir,  pattern = "\\.maf$", full.names = TRUE),
  list.files(vandy_dir, pattern = "\\.maf$", full.names = TRUE)
)

cat("Total MAF files found:", length(maf_files), "\n")
```

## COMBINING ALL MAFS
```{r, eval = FALSE}
# Process each MAF
all_mafs_list <- lapply(maf_files, function(file_path) {
  
  dat <- read.delim(file_path, comment.char = "#", stringsAsFactors = FALSE)
  
  # Replacing UNKNOWN in Sample_Barcode with Run ID
  fname <- basename(file_path) # Extract both IDs from filename
  # removes everything starting from the first dot and split by "_vs_"
  ids <- unlist(strsplit(clean_name <- gsub("\\..*", "", fname), "_vs_"))
  
  tumor_id  <- ids[1]
  normal_id <- ids[2]
  
  # Replace BOTH barcodes
  dat$Tumor_Sample_Barcode  <- tumor_id
  dat$Matched_Norm_Sample_Barcode <- normal_id
  
  # Track cohort source
  dat$Cohort <- ifelse(grepl("UCLA", file_path),
                       "UCLA",
                       "VANDERBILT")
  return(dat)
})

# Combine all MAFs
combined_df <- do.call(rbind, all_mafs_list)
cat("Total variants after merge:", nrow(combined_df), "\n")
```



## MERGING MMC1 METADATA WITH combined_df: 
```{r, eval=FALSE}
# Build MAF object to contain both maf and clinical data
merged_maf <- read.maf(maf = combined_df, clinicalData = clinical_df_og)

# Check summary
getSampleSummary(merged_maf)
```
## Checking to see whether we can call specific records from merged_maf
```{r}
# Filter clinical data for sample SRR4289724
sample_clinical <- subset(getClinicalData(merged_maf), Matched_Norm_Sample_Barcode == "SRR4289724")
print(sample_clinical)
```

```{r}
# Check possible variant_types
unique(merged_maf@data$Variant_Type)
```
```{r}
# Check possible Variant_Classification
unique(merged_maf@data$Variant_Classification)
```

# START HERE ON VLAB !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!

## saving data to use on VLab:
```{r}
# # Save as an RDS file for R
# saveRDS(merged_maf, file = "/rds/projects/e/elhamsak-group5/main_project/scripts/wes/R/merged_maf.rds")
# 
# 
# # Open in Vlab with: 
# merged_maf <- readRDS("~/module3_genomics_and_ngs/project_analysis/merged_maf.rds")
```

## CALCULATING NUMBER OF NON-SYNONYMOUS MUTATIONS:

```{r}
# Define non-synonymous SNV classes
nsSNV_classes <- c(
  "Missense_Mutation", "Nonsense_Mutation",
  "Nonstop_Mutation", "Splice_Site",
  "Translation_Start_Site"
)

# Define all non-synonymous classes
ns_nonsilent_classes <- c(
  nsSNV_classes,
  "Frame_Shift_Del", "Frame_Shift_Ins",
  "In_Frame_Del", "In_Frame_Ins"
)

# Calculate only SNV counts
nsSNV_counts <- merged_maf@data %>%
  filter(Variant_Type == "SNP", 
         Variant_Classification %in% nsSNV_classes) %>%
  count(Tumor_Sample_Barcode, name = "nsSNV")

# Calculate all non-silent variants
non_silent_counts <- merged_maf@data %>%
  filter(Variant_Classification %in% ns_nonsilent_classes) %>%
  count(Tumor_Sample_Barcode, name = "all_nonsilent_vars")

# Add counts from author data for validation
# Load author data
author_data <- read.csv("Snv_counts.csv", stringsAsFactors = FALSE)

# Map Patient.ID to Tumor_Sample_Barcode using your clinical metadata
author_data_mapped <- author_data %>%
  left_join(
    clinical_df_og %>% select(Tumor_Sample_Barcode, Patient.ID),
    by = "Patient.ID"
  ) %>%
  # Keep only columns we need for TMB calculation
  select(Tumor_Sample_Barcode, TotalNonSyn, TotalNonSyn_Exp)
```

## CALCULATING TMB:
```{r}
# 1. Load callable base summary
# Format: Tumor_Sample_Barcode, Matched_Norm_Sample_Barcode, Total_Bases, Total_MB
tmb_df <- read.delim("/rds/projects/e/elhamsak-group5/main_project/results/wes/coverage_results/all_samples_callable_bases.txt",
                          header = FALSE, stringsAsFactors = FALSE)
colnames(tmb_df) <- c("Tumor_Sample_Barcode", "Matched_Norm_Sample_Barcode", "Total_Bases", "Callable_Mb")

# Optional: filter out low coverage samples
min_callable_mb <- 50
tmb_df <- tmb_df %>% filter(Callable_Mb >= min_callable_mb)

# 2. Merge nsSNV and non-silent variant counts
tmb_df <- tmb_df %>%
  left_join(nsSNV_counts, by = "Tumor_Sample_Barcode") %>%
  left_join(non_silent_counts, by = "Tumor_Sample_Barcode")

# 3. Merge author data
tmb_df <- tmb_df %>%
  left_join(author_data_mapped, by = "Tumor_Sample_Barcode")

# 4. Calculate TMB
# TMB = nsSNV / Callable Mb
tmb_df <- tmb_df %>%
  mutate(TMB = nsSNV / Callable_Mb)

# 5. Rearrange columns
tmb_df <- tmb_df %>%
  select(
    Tumor_Sample_Barcode,
    Matched_Norm_Sample_Barcode,
    nsSNV,
    all_nonsilent_vars,
    TotalNonSyn,
    TotalNonSyn_Exp,
    Total_Bases,
    Callable_Mb,
    TMB
  )

# 6. Inspect
head(tmb_df)
```


## COLLECTING DATA FOR PLOTTING FIG 1C:
To create figure 1C, need to make a df containing the columns:
1. Patient.ID (Pt1, Pt2, etc)
2. irRECIST ("Progressive Disease", "Partial Response", "Complete Response") -> (Responding, Non-responding)
3. Overall.Survival (days of survival)
4. Vital.Status (Dead or Alive)
5. number of non-synonymous mutations. 
6. TMB (High, Low)

```{r}
# 1. Start with clinical data
fig1c_df <- getClinicalData(merged_maf) %>%
  select(Patient.ID, Tumor_Sample_Barcode, Matched_Norm_Sample_Barcode,
         irRECIST, Overall.Survival, Vital.Status)

# 2. Join the TMB table for mutation counts and calculated TMB
fig1c_df <- fig1c_df %>%
  left_join(
    tmb_df %>%
      select(Tumor_Sample_Barcode, nsSNV, all_nonsilent_vars, 
             TotalNonSyn, TotalNonSyn_Exp, Callable_Mb, TMB),
    by = "Tumor_Sample_Barcode"
  )

# 4. Handle NAs for samples with zero mutations
fig1c_df <- fig1c_df %>%
  mutate(across(c(nsSNV, all_nonsilent_vars, TotalNonSyn, TotalNonSyn_Exp, TMB),
                ~replace_na(.x, 0)))

# 5. Define Response Factor for plotting
fig1c_df <- fig1c_df %>%
  mutate(Response = case_when(
    irRECIST %in% c("Complete Response", "Partial Response") ~ "Responding",
    irRECIST == "Progressive Disease" ~ "Non-responding",
    TRUE ~ "Other"
  ))

# 6. Optional: Filter extreme outliers (e.g., very high nsSNV)
fig1c_df_filtered <- fig1c_df %>%
  filter(nsSNV < 10000)

head(fig1c_df_filtered)
```

## CREATING THE PLOT 1C USING ONLY NSSNV COUNTS: 
```{r}
# 1. Prepare the dataframe
# We use 'nsSNV' because that is the name you gave the column in Step 1
plot_data_1c_TMB <- fig1c_df_filtered %>%
  # Filter for patients who have a known response
  filter(Response != "Other") %>% 
  group_by(Response) %>%
  mutate(
    group_median = median(nsSNV, na.rm = TRUE), 
    Load_Level = ifelse(nsSNV >= group_median, "high nsSNV", "low nsSNV"),
    Group_Label = paste(Response, Load_Level, sep = "\n")
  ) %>%
  ungroup()

# 2. Fix X-axis order and labels to match your specific 'case_when' logic
# Note: Your case_when used "Responding" and "Non-responding"
plot_data_1c_TMB$Group_Label <- factor(plot_data_1c$Group_Label, levels = c(
  "Responding\nhigh nsSNV", 
  "Responding\nlow nsSNV", 
  "Non-responding\nhigh nsSNV", 
  "Non-responding\nlow nsSNV"
))

# 3. Create the Plot
p1c_tmb <- ggplot(plot_data_1c_TMB, aes(x = Group_Label, y = nsSNV / 1000)) +
  geom_boxplot(outlier.shape = NA, width = 0.6, fill = "white", color = "black") +
  geom_jitter(width = 0.1, alpha = 0.7, color = "#D55E00") + 
  theme_bw() +
  theme(panel.grid = element_blank(), 
        axis.text.x = element_text(size = 10)) +
  labs(y = "Somatic nsSNVs (in 1000s)", x = "", title = "Figure 1C") +
  # Use exact levels for the comparison
  stat_compare_means(
    method = "wilcox.test",
    comparisons = list(c("Responding\nhigh nsSNV", "Non-responding\nhigh nsSNV")),
    label = "p.format"
  )

# 4. Save
ggsave("Figure_1C_counts.png", plot = p1c_tmb, width = 5.5, height = 5.5)

# p1c_tmb
```

## CREATING THE PLOT 1C USING TMB:  
```{r}
# Filter, group, and assign high/low TMB
plot_data_1c_counts <- fig1c_df_filtered %>%
  filter(Response != "Other") %>% 
  group_by(Response) %>%
  mutate(
    group_median = median(TMB, na.rm = TRUE), 
    Load_Level = ifelse(TMB >= group_median, "high TMB", "low TMB"),
    Group_Label = paste(Response, Load_Level, sep = "\n")
  ) %>%
  ungroup()

# Fix X-axis order
plot_data_1c_counts$Group_Label <- factor(plot_data_1c$Group_Label, levels = c(
  "Responding\nhigh TMB",
  "Responding\nlow TMB",
  "Non-responding\nhigh TMB",
  "Non-responding\nlow TMB"
))

p1c_counts <- ggplot(plot_data_1c_counts, aes(x = Group_Label, y = TMB)) +  # use TMB here
  geom_boxplot(outlier.shape = NA, width = 0.6, fill = "white", color = "black") +
  geom_jitter(width = 0.1, alpha = 0.7, color = "#D55E00") + 
  theme_bw() +
  theme(panel.grid = element_blank(), 
        axis.text.x = element_text(size = 10)) +
  labs(y = "Tumor Mutational Burden (mutations/Mb)", x = "", title = "Figure 1C") +
  stat_compare_means(
    method = "wilcox.test",
    comparisons = list(c("Responding\nhigh TMB", "Non-responding\nhigh TMB")),
    label = "p.format"
  )

# Save the plot
ggsave("Figure_1C_tmb.png", plot = p1c, width = 5.5, height = 5.5)

# p1c_counts

```



## COLLECTING DATA TO PLOT 1D (ONLY COUNTS)

```{r}
library(survival)

# 1. Clean the data and REMOVE the extreme outlier first
surv_df_1d_counts <- fig1c_df_filtered %>%
  filter(nsSNV < 10000) %>% # Remove the ~18k outlier
  filter(Response != "Other") %>% 
  group_by(Response) %>%
  mutate(
    # Recalculate median WITHOUT the outlier
    group_median = median(nsSNV, na.rm = TRUE), 
    Load_Level = ifelse(nsSNV >= group_median, "high nsSNV", "low nsSNV"),
    Group_Label = paste(Response, Load_Level, sep = "\n")
  ) %>%
  ungroup() %>%
  mutate(
    status_num = ifelse(Vital.Status == "Dead", 1, 0),
    time_years = as.numeric(Overall.Survival) / 365
  )
head(surv_df_1d_counts)
```

## PLOTTING 1D USING ONLY NS SNV COUNTS: 
```{r}

# 2. generate the survival fit
fit_1d_counts <- survfit(Surv(time_years, status_num) ~ Group_Label, data = surv_df_1d_counts)

extract_surv <- function(fit) {
  data.frame(
    time = fit$time,
    surv = fit$surv,
    n.censor = fit$n.censor,
    group = rep(names(fit$strata), fit$strata)
  )
}

# Perform the Log-Rank test
sd <- survdiff(Surv(time_years, status_num) ~ Group_Label, data = surv_df_1d_counts)

# Extract the p-value from the test result
# The formula for p-value from a chi-squared distribution:
p_val <- 1 - pchisq(sd$chisq, length(sd$n) - 1)

# Format the p-value for your plot (e.g., "p = 0.0101")
p_label <- paste0("p = ", signif(p_val, 3))

print(p_label)

plot_data_surv_1d_counts <- extract_surv(fit_1d_counts)

p1d_counts <- plot(
  plot_data_surv_1d_counts,
  col = c("red", "blue"),
  lty = c(2, 3),
  lwd = 2,
  mark.time = TRUE,
  mark = 3,
  xlab = "Survival (years)",
  ylab = "Fraction surviving",
  xlim = c(0, 6),
  ylim = c(0, 1)
)

legend(
  "topright",
  title = "nsSNV count",
  legend = c("Top third", "Bottom third"),
  pch = 15,
  col = c("red", "blue"),
  pt.cex = 1.5,
  bty = "n"
)

text(4.6, 0.25, labels = paste0(p_label))

# 5. Save
# ggsave("Figure_1D_KM_counts.png", plot = p1d, width = 5.5, height = 5.5)

# p1d
```
## COLLECTING DATA TO PLOT 1D (TMB)

```{r}
library(survival)

# 1. Clean the data and REMOVE the extreme outlier first
surv_df_1d_tmb <- fig1c_df_filtered %>%
  filter(nsSNV < 10000) %>% # Remove the ~18k outlier
  filter(Response != "Other") %>% 
  group_by(Response) %>%
  mutate(
    # Recalculate median WITHOUT the outlier
    group_median = median(TMB, na.rm = TRUE), 
    Load_Level = ifelse(TMB >= group_median, "high nsSNV", "low nsSNV"),
    Group_Label = paste(Response, Load_Level, sep = "\n")
  ) %>%
  ungroup() %>%
  mutate(
    status_num = ifelse(Vital.Status == "Dead", 1, 0),
    time_years = as.numeric(Overall.Survival) / 365
  )
head(surv_df_1d_tmb)

```
## PLOTTING 1D USING TMB RATIO: 
```{r}

# 2. generate the survival fit
fit_1d_tmb <- survfit(Surv(time_years, status_num) ~ Group_Label, data = surv_df_1d_tmb)

extract_surv <- function(fit) {
  data.frame(
    time = fit$time,
    surv = fit$surv,
    n.censor = fit$n.censor,
    group = rep(names(fit$strata), fit$strata)
  )
}

plot_data_surv_1d_tmb <- extract_surv(fit_1d_tmb)

# 4. Create Figure 1D
p1d_counts <- ggplot(plot_data_surv_1d_tmb, aes(x = time, y = surv, color = group)) +
  geom_step(linewidth = 1) + 
  # Add the + marks for censored patients (Alive)
  geom_point(data = subset(plot_data_surv_1d_tmb, n.censor > 0), 
             aes(x = time, y = surv), shape = 3, size = 2) +
  scale_color_manual(values = c(
    "Group_Label=Responding\nhigh TMB" = "red",
    "Group_Label=Responding\nlow TMB" = "orange",
    "Group_Label=Non-responding\nhigh TMB" = "green3",
    "Group_Label=Non-responding\nlow TMB" = "blue"
  )) +
  theme_classic() +
  labs(
    x = "Survival (years)",
    y = "Fraction surviving",
    title = "Figure 1D: Kaplan-Meier (ggplot2)",
    color = "Group"
  )

# 5. Save
ggsave("Figure_1D_KM_tmb.png", plot = p1d, width = 5.5, height = 5.5)

# p1d
```


## FIGURE 1G DATA PREPARATION:
```{r}
# Identify patients with BRCA2 mutations
brca2_mutants <- merged_maf@data %>%
  filter(Hugo_Symbol == "BRCA2") %>%
  pull(Tumor_Sample_Barcode) %>%
  unique()

# Add BRCA2 status to your main clinical dataframe
fig1g_df <- fig1c_df %>%
  mutate(BRCA2_Status = ifelse(Tumor_Sample_Barcode %in% brca2_mutants, 
                               "BRCA2 mutant", "BRCA2 WT")) %>%
  # Filter to ensure we have the counts (using the nsSNV column we created earlier)
  filter(!is.na(nsSNV))

# Filter the dataframe to remove the hypermutated outlier
fig1g_df_filtered <- fig1g_df %>%
  filter(nsSNV < 10000)

# Fix the factor levels for the plot order
fig1g_df_filtered$BRCA2_Status <- factor(fig1g_df_filtered$BRCA2_Status, 
                                levels = c("BRCA2 WT", "BRCA2 mutant"))
```


## CREATING PLOT
```{r}
p1g <- ggplot(fig1g_df_filtered, aes(x = BRCA2_Status, y = nsSNV / 1000)) +
  geom_boxplot(outlier.shape = NA, width = 0.5) +
  geom_jitter(width = 0.1, color = "firebrick", alpha = 0.6) +
  theme_classic() +
  labs(
    y = "Somatic nsSNVs (in 1000s)",
    x = "",
    title = "Figure 1G: Mutational Load in BRCA2 Mutants"
  ) +
  # Use stat_compare_means for the Mann-Whitney test p-value
  stat_compare_means(
    method = "wilcox.test", 
    label.x = 1.5, 
    label.y = 3.2,
    label = "p.format"
  ) +
  # Optional: Match the sample counts in the X-axis labels
  scale_x_discrete(labels = c(
    "BRCA2 WT\n(n=31)", 
    "BRCA2 mutant\n(n=7)"
  ))

# Save the plot
ggsave("Figure_1G_BRCA2.png", plot = p1g, width = 6, height = 6)

# Add a specific label for Pt 20
# The original paper specifically highlights Pt 20 as a "Non-responding" patient within the mutant group
# p1g <- p1g + 
#   geom_text(data = filter(fig1g_df, Patient.ID == "Pt20"),
#             aes(label = "Pt 20\nNon-responding"),
#             hjust = -0.2, vjust = 0.5, size = 3)

p1g
```

## FIGURE 1E:
```{r}

# Create a 'Response' column in clinical data if it doesn't exist to simplify grouping
merged_maf@clinical.data$Response <- ifelse(
  merged_maf@clinical.data$irRECIST %in% c("Complete Response", "Partial Response"), 
  "Responding", "Non-responding"
)

# 1. Subset the MAF for Responding patients
res_maf <- subsetMaf(maf = merged_maf, 
                      query = "Response == 'Responding'")

# 2. Subset the MAF for Non-responding patients
nonres_maf <- subsetMaf(maf = merged_maf, 
                         query = "Response == 'Non-responding'")

# 3. Now run the comparison
comp <- mafCompare(m1 = res_maf, m2 = nonres_maf, 
                   m1Name = 'Responding', m2Name = 'Non-responding')

# 4. View the results
print(comp$results)
```

```{r}
# 1. Identify barcodes for Responding patients
res_barcodes <- merged_maf@clinical.data %>%
  filter(irRECIST %in% c('Partial Response', 'Complete Response')) %>%
  pull(Tumor_Sample_Barcode)

# 2. Identify barcodes for Non-responding patients
nonres_barcodes <- merged_maf@clinical.data %>%
  filter(irRECIST == 'Progressive Disease') %>%
  pull(Tumor_Sample_Barcode)

# 3. Create the subsetted MAF objects using the 'tsbs' argument
res_maf <- subsetMaf(maf = merged_maf, tsb = res_barcodes)
nonres_maf <- subsetMaf(maf = merged_maf, tsb = nonres_barcodes)

# 4. Run the comparison (Fisher's Exact Test)
comp <- mafCompare(m1 = res_maf, m2 = nonres_maf, 
                   m1Name = 'Responding', m2Name = 'Non-responding')

print(comp$results)
```

## CREATING PLOT:
```{r}
# Define the gene list exactly as in the paper
target_genes <- c("BRAF", "NRAS", "NF1", "FREM1", "OR13C5", "FMO1", "UTRN", 
                  "LPHN3", "SP140L", "ITGA9", "ABCA7", "OR10J1", "MUC12", 
                  "ZNF534", "AMER3", "BRCA2", "TRPM2", "CLEC14A")

# Generate the OncoPrint
oncoplot(
  maf = merged_maf,
  genes = target_genes,
  clinicalFeatures = 'irRECIST', 
  sortByAnnotation = TRUE,
  # This disables the top bars so we can match the paper's bottom layout
  topBarData = NULL, 
  # This ensures we see the sample IDs (Pt1, Pt2, etc.)
  showTumorSampleBarcodes = TRUE, 
  barcode_mar = 4,
  gene_mar = 8
)
```


