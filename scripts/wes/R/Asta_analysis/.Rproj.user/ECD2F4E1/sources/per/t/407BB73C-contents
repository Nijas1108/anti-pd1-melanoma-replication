---
title: "aish_analysis"
output: html_document
date: "2026-01-16"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## LOADING LIBRARIES: 
```{r}
library(maftools)
library(dplyr)
library(ggplot2)
```
## LOAD IN MMC1 METADATA:
```{r}
# Read clinical metadata into a datafram
clinical_df_og <- read.csv("mmc1.csv", stringsAsFactors = FALSE)

# Rename the sample ID column to match the MAF sample ID column (Sample_Barcode) - required when merging data with MAF
# Check CSV and use the name of the column here:
colnames(clinical_df_og)[colnames(clinical_df_og) == "SRA.Run.ID..tumor.WES"] <- "Tumor_Sample_Barcode"
colnames(clinical_df_og)[colnames(clinical_df_og) == "SRA.Run.ID..normal.WES"] <- "Matched_Norm_Sample_Barcode"
```

## LOADING IN MAF FILES: 
```{r}
# 1. Define the two directories
ucla_dir <- "/rds/projects/e/elhamsak-group5/main_project/annotation/ucla_processed_bed"
vandy_dir <- "/rds/projects/e/elhamsak-group5/main_project/annotation/vanderbilt_processed_bed" 

# Collect all MAF files
maf_files <- c(
  list.files(ucla_dir,  pattern = "\\.maf$", full.names = TRUE),
  list.files(vandy_dir, pattern = "\\.maf$", full.names = TRUE)
)

cat("Total MAF files found:", length(maf_files), "\n")
```

## COMBINING ALL MAFS
```{r}
# Process each MAF
all_mafs_list <- lapply(maf_files, function(file_path) {
  
  dat <- read.delim(file_path, comment.char = "#", stringsAsFactors = FALSE)
  
  # Replacing UNKNOWN in Sample_Barcode with Run ID
  fname <- basename(file_path) # Extract both IDs from filename
  # removes everything starting from the first dot and split by "_vs_"
  ids <- unlist(strsplit(clean_name <- gsub("\\..*", "", fname), "_vs_"))
  
  tumor_id  <- ids[1]
  normal_id <- ids[2]
  
  # Replace BOTH barcodes
  dat$Tumor_Sample_Barcode  <- tumor_id
  dat$Matched_Norm_Sample_Barcode <- normal_id
  
  # Track cohort source
  dat$Cohort <- ifelse(grepl("UCLA", file_path),
                       "UCLA",
                       "VANDERBILT")
  return(dat)
})

# Combine all MAFs
combined_df <- do.call(rbind, all_mafs_list)
cat("Total variants after merge:", nrow(combined_df), "\n")
```

## MERGING MMC1 METADATA WITH combined_df: 
```{r}
# Build MAF object to contain both maf and clinical data
merged_maf <- read.maf(maf = combined_df,
                       clinicalData = clinical_df_og)

# Check summary
getSampleSummary(merged_maf)
```
## Checking to see whether we can call specific records from merged_maf
```{r}
# Filter clinical data for sample SRR4289724
sample_clinical <- subset(getClinicalData(merged_maf),
                          Matched_Norm_Sample_Barcode == "SRR4289724")
print(sample_clinical)
```

```{r}
# checking possible variant_types
unique(merged_maf@data$Variant_Type)
```
```{r}
# checking possible Variant_Classification
unique(merged_maf@data$Variant_Classification)
```
## saving data into my space on VLab:
```{r}
# Save as an RDS file for R
saveRDS(merged_maf, file = "/rds/projects/e/elhamsak-group5/main_project/genomics_analysis/aish_analysis/merged_maf.rds")

# open in Vlab with: 
# merged_df <- readRDS("P:/my_folder/merged_df.rds") # 'P:' is often the mapped RDS drive
```

## CALCULATING NUMBER OF NON-SYNONYMOUS MUTATIONS:

```{r}
nsSNV_classes <- c(
  "Missense_Mutation", "Nonsense_Mutation",
  "Nonstop_Mutation", "Splice_Site",
  "Translation_Start_Site"
)

ns_nonsilent_classes <- c(
  nsSNV_classes,
  "Frame_Shift_Del", "Frame_Shift_Ins",
  "In_Frame_Del", "In_Frame_Ins"
)

# Calculating only SNV counts
nsSNV_counts <- merged_maf@data %>%
  filter(Variant_Type == "SNP", 
         Variant_Classification %in% nsSNV_classes) %>%
  count(Tumor_Sample_Barcode, name = "nsSNV")

# Calculating all non-silent variants
non_silent_counts <- merged_maf@data %>%
  filter(Variant_Classification %in% ns_nonsilent_classes) %>%
  count(Tumor_Sample_Barcode, name = "all_nonsilent_vars")

# adding counts from author data for validation
# load author data
author_data <- read.csv("Snv_counts.csv", stringsAsFactors = FALSE)
```

## CREATING DF FOR PLOTTING FIG 1C:
To create figure 1C, need to make a df containing the columns:
1. Patient.ID (Pt1, Pt2, etc)
2. irRECIST ("Progressive Disease", "Partial Response", "Complete Response"),
3. Overall.Survival (months of survival)
4. Vital.Status (Dead or Alive)
5. number of non-synonymous mutations (need to calculate)

```{r}
# 1. Start with your Clinical Data (The "Master List" of patients)
fig1c_df <- getClinicalData(merged_maf) %>%
  select(Patient.ID, Tumor_Sample_Barcode, Matched_Norm_Sample_Barcode,
         irRECIST, Overall.Survival, Vital.Status)

# 2. Join the SNV counts
fig1c_df <- fig1c_df %>%
  left_join(nsSNV_counts, by = "Tumor_Sample_Barcode")

# 3. Join the All Non-Silent counts
fig1c_df <- fig1c_df %>%
  left_join(non_silent_counts, by = "Tumor_Sample_Barcode")

# 4. Join the Author Data for validation
# (Assuming author_data has a matching ID column like 'Tumor_Sample_Barcode')
fig1c_df <- fig1c_df %>%
  left_join(author_data, by = "Patient.ID")

# 5. Handle NAs (Samples with 0 mutations might show up as NA after joining)
fig1c_df[is.na(fig1c_df)] <- 0


# 6. Final Touch: Create the Responding vs. Non-Responding factor
# Hugo et al. defined CR/PR as Responding and PD as Non-responding

fig1c_df <- fig1c_df %>%
  mutate(Response = case_when(
    irRECIST %in% c("Complete Response", "Partial Response") ~ "Responding",
    irRECIST == "Progressive Disease" ~ "Non-responding",
    TRUE ~ "Other"
  ))
```

## Checking correlation between our counts and author counts
```{r}
# Quick validation check
plot(fig1c_df$nsSNV, fig1c_df$TotalNonSyn, 
     xlab="My Calculation", ylab="Author Calculation", 
     main="Validation of SNV Counts")
abline(0,1, col="red")
```











